<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
</head>

<body>
    <div id="container" style="display: flex;flex-direction: row;justify-content: center;height:100%">
        <iframe id="editor" style="width:49vw;">
        </iframe>
        <div style="clear:both">
            <div id="scrollLock"
                style="margin-bottom:0.2vw;padding:0.2vw;font-size: 1vw;border-radius: 0.7vw;background-color: #0DD;text-align: center;user-select: none;height:1.4vw;width:1.4vw">
                üîí</div>
            <div id="save"
                style="margin-bottom:0.2vw;padding:0.2vw;font-size: 1vw;border-radius: 0.7vw;background-color: #0DD;text-align: center;user-select: none;height:1.4vw;width:1.4vw">
                üíæ</div>
            <div id="print"
                style="margin-bottom:0.2vw;padding:0.2vw;font-size: 1vw;border-radius: 0.7vw;background-color: #0DD;text-align: center;user-select: none;height:1.4vw;width:1.4vw">
                üìÉ</div>
            <div id="clear"
                style="margin-bottom:0.2vw;padding:0.2vw;font-size: 1vw;border-radius: 0.7vw;background-color: #0DD;text-align: center;user-select: none;height:1.4vw;width:1.4vw">
                üîÉ</div>
        </div>
        <iframe id="preview" style="width:49vw;margin-left:auto">
        </iframe>
    </div>
    <script type="module">
        import { personalInformation } from "./personalInformation.js"
        import { educationExperience } from "./educationExperience.js"
        import { award } from "./award.js"
        import { personalSkill } from "./personalSkill.js"
        import { workExperience } from "./workExperience.js"
        import { projectExperience } from "./projectExperience.js"
        import { readAsStringAsync } from "./fileReader.js"
        import { findTitle, split, removeAnnotation, findPersonalInformation } from "./baseMatcher.js"
        import { bindJumperByPosition } from "./positionJumper.js"
        let str = "";

        let editor = document.getElementById('editor');
        let preview = document.getElementById('preview');

        let editorWindow = editor.contentWindow;
        let previewWindow = preview.contentWindow;

        let scrollTarget = null;
        let scrollLock = true;



        let editorDoc = editorWindow.document;
        let previewDoc = previewWindow.document;

        let editorArea = editorDoc.createElement('textarea');
        // editorArea.style = "height:auto;white-space: pre-wrap;border:none;resize:none;padding:1vw"
        editorArea.style = "width: 100%; height: 100%; resize: none; border: none; padding: 1vw;font-size:1.5vw; box-sizing: border-box;";
        editorArea.setAttribute('contenteditable', true);
        editorArea.setAttribute('user-modify', "read-write-plaintext-only");
        window.addEventListener('load', async function () {
            if (localStorage.getItem("myVitae") != null && localStorage.getItem("myVitae") != undefined) {
                str = localStorage.getItem("myVitae")
            }
            else {
                str = await readAsStringAsync("./MyVitae.md");
            }
            editorArea.value = str;
            render(str)
        })

        editorDoc.addEventListener('keydown', function (event) {
            if ((event.key == 'p' || event.key == 'P') && (navigator.platform.match("Mac") ? event.metaKey : event.ctrlKey)) {// ctrl+p
                event.preventDefault();
                previewWindow.print()
            } else if ((event.key == 's' || event.key == 'S') && (navigator.platform.match("Mac") ? event.metaKey : event.ctrlKey)) {//ctrl+s
                event.preventDefault();
                localStorage.setItem("myVitae", editorArea.value)
            }
        })
        previewDoc.addEventListener('keydown', function (event) {
            if ((event.key == 'p' || event.key == 'P') && (navigator.platform.match("Mac") ? event.metaKey : event.ctrlKey)) {// ctrl+p
                event.preventDefault();
                previewWindow.print()
            }
            else if ((event.key == 's' || event.key == 'S') && (navigator.platform.match("Mac") ? event.metaKey : event.ctrlKey)) {//ctrl+s
                event.preventDefault();
                localStorage.setItem("myVitae", editorArea.value)
            }
        })
        document.addEventListener('keydown', function (event) {
            if ((event.key == 'p' || event.key == 'P') && (navigator.platform.match("Mac") ? event.metaKey : event.ctrlKey)) {// ctrl+p
                event.preventDefault();
                previewWindow.print()
            }
            else if ((event.key == 's' || event.key == 'S') && (navigator.platform.match("Mac") ? event.metaKey : event.ctrlKey)) {//ctrl+s
                event.preventDefault();
                localStorage.setItem("myVitae", editorArea.value)
            }
        })
        editorArea.addEventListener('mouseover', function (event) {
            scrollTarget = editorArea;
        })
        previewWindow.addEventListener('mouseover', function (event) {
            scrollTarget = previewWindow;
        })

        editorArea.addEventListener('scroll', function (event) {
            if (scrollLock && scrollTarget === editorArea) {
                previewWindow.scroll({
                    top: editorArea.scrollTop * (previewDoc.body.scrollHeight - previewDoc.body.clientHeight) / (editorArea.scrollHeight - editorArea.clientHeight),
                });
            }
        })
        previewWindow.addEventListener('scroll', function (event) {
            if (scrollLock && scrollTarget === previewWindow) {
                editorArea.scroll({
                    top: previewWindow.scrollY * (editorArea.scrollHeight - editorArea.clientHeight) / (previewDoc.body.scrollHeight - previewDoc.body.clientHeight),
                });
            }
        })

        editorArea.addEventListener('keyup', function () {
            str = editorArea.value;
            render(str)
        })

        let scrollLockButton = document.getElementById("scrollLock");
        scrollLockButton.addEventListener("click", function (event) {
            if (scrollLock) {
                scrollLockButton.innerText = "üîì";
            }
            else {
                scrollLockButton.innerText = "üîí";
            }
            scrollLock = !scrollLock;
        })

        let saveButton = document.getElementById("save");
        saveButton.addEventListener("click", function (event) {
            localStorage.setItem("myVitae", editorArea.innerText)
        })

        let printButton = document.getElementById("print");
        printButton.addEventListener("click", function (event) {
            previewWindow.print();
        })

        let clearButton = document.getElementById("clear");
        clearButton.addEventListener("click", async function (event) {
            localStorage.removeItem("myVitae");
            render(await readAsStringAsync("./MyVitae.md"))
        })

        editorDoc.body.appendChild(editorArea);

        function render(str) {
            previewDoc.body.innerHTML = "";
            let subTokens = split(str)
            let titleModuleMap = {
                "‰∏™‰∫∫‰ø°ÊÅØ": personalInformation,
                "ÊïôËÇ≤ÁªèÂéÜ": educationExperience,
                "Ëé∑Â•ñÁªèÂéÜ": award,
                "‰∏™‰∫∫ÊäÄËÉΩ": personalSkill,
                "Â∑•‰ΩúÁªèÂéÜ": workExperience,
                "È°πÁõÆÁªèÂéÜ": projectExperience,
            }
            let moduleOrder = [
                "‰∏™‰∫∫‰ø°ÊÅØ",
                "ÊïôËÇ≤ÁªèÂéÜ",
                "Ëé∑Â•ñÁªèÂéÜ",
                // "‰∏™‰∫∫ÊäÄËÉΩ",
                // "Â∑•‰ΩúÁªèÂéÜ",
                // "È°πÁõÆÁªèÂéÜ"
            ]
            for (let key of moduleOrder) {
                if (titleModuleMap[key] != null && subTokens[key] != null) {
                    previewDoc.body.appendChild(
                        titleModuleMap[key].render(
                            titleModuleMap[key].parse(
                                subTokens[key]
                            )
                        )
                    )
                }
            }
            bindJumperByPosition(editorArea, previewDoc);
        }

    </script>

</body>

</html>