<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
</head>

<body>
    <div id="container" class="container">
        <iframe id="editor" class="editor">
        </iframe>
        <div style="clear:both">
            <div id="scrollLock" class="page-button"> </div>
            <div id="save" class="page-button"></div>
            <div id="print" class="page-button"></div>
            <div id="clear" class="page-button"></div>
            <div id="link" class="page-button"></div>
            <div id="style" class="page-button"></div>
            <div id="color" class="page-button"></div>
        </div>
        <iframe id="preview" class="preview">
        </iframe>
    </div>
    <div id="messageListContainer" class="message-list-container">
    </div>

    </div>
    <script type="module">
        import { personalInformation } from "./personalInformation.js"
        import { educationExperience } from "./educationExperience.js"
        import { award } from "./award.js"
        import { personalSkill } from "./personalSkill.js"
        import { workExperience } from "./workExperience.js"
        import { projectExperience } from "./projectExperience.js"
        import { readAsStringAsync } from "./fileReader.js"
        import { findTitle, split, removeAnnotation, findPersonalInformation, removeATag, expandATag } from "./baseMatcher.js"
        import { bindJumperByPosition } from "./positionJumper.js"
        import {
            loadLinksTo,
            removeLinksFrom,
            createScrollLockIcon,
            createScrollUnlockIcon,
            createSaveIcon,
            createPrintIcon,
            createClearIcon,
            createLinkIcon,
            createHideLinkIcon,
            createDetailLinkIcon,
            createStyleIcon,
            createFullColorIcon,
            createGrayColorIcon,
            initMessageList,
            showMessage
        } from "./uiCreator.js"
        let str = "";
        let editor = document.getElementById('editor');
        let preview = document.getElementById('preview');

        let editorWindow = editor.contentWindow;
        let previewWindow = preview.contentWindow;

        let scrollTarget = null;
        let scrollLock = true;
        let showLink = 0;

        let fullColor = true;

        let styles = ["main", "autumn"]
        let styleIndex = 0

        let editorDoc = editorWindow.document;
        let previewDoc = previewWindow.document;

        function loadStyle(style, clear) {
            loadLinksTo(document, [
                `css/${style}/icon.css`,
                `css/${style}/page.css`,
                `css/${style}/message.css`
            ], clear)
            loadLinksTo(editorDoc, [
                `css/${style}/editor.css`
            ], clear)
            loadLinksTo(previewDoc, [
                `css/${style}/preview/preview.css`,
                `css/${style}/preview/personalInformation.css`,
                `css/${style}/preview/educationExperience.css`,
                `css/${style}/preview/award.css`,
                `css/${style}/preview/workExperience.css`,
                `css/${style}/preview/projectExperience.css`,
                `css/${style}/preview/personalSkill.css`,
            ], clear)
        }
        // loadLinksTo(document, [
        //     `css/main/icon.css`,
        //     `css/main/page.css`,
        //     `css/main/message.css`
        // ])
        loadStyle(styles[styleIndex])
        let scrollLockHTML = ""
        let scrollUnlockHTML = ""
        let showLinkHTML = ""
        let hideLinkHTML = ""
        let detailLinkHTML = ""
        let fullColorHTML = ""
        let grayColorHTML = ""

        let editorArea = editorDoc.createElement('textarea');
        editorArea.setAttribute('contenteditable', true);
        editorArea.setAttribute('user-modify', "read-write-plaintext-only");
        editorArea.className = "area";
        editorDoc.body.appendChild(editorArea);

        let scrollLockButton = document.getElementById("scrollLock");
        let saveButton = document.getElementById("save");
        let printButton = document.getElementById("print");
        let clearButton = document.getElementById("clear");
        let linkButton = document.getElementById("link");
        let styleButton = document.getElementById("style");
        let colorButton = document.getElementById("color");

        let messageList = initMessageList(document.getElementById('messageListContainer'))

        window.addEventListener('load', async function () {
            if (localStorage.getItem("myVitae") != null && localStorage.getItem("myVitae") != undefined) {
                str = localStorage.getItem("myVitae")
            }
            else {
                str = await readAsStringAsync("./MyVitae.md");
            }
            scrollLockHTML = await createScrollLockIcon(scrollLockButton)
            scrollUnlockHTML = await createScrollUnlockIcon()
            showLinkHTML = await createLinkIcon(linkButton)
            hideLinkHTML = await createHideLinkIcon()
            detailLinkHTML = await createDetailLinkIcon()
            fullColorHTML = await createFullColorIcon(colorButton)
            grayColorHTML = await createGrayColorIcon()
            editorArea.value = str;
            render(str)
        })

        editorDoc.addEventListener('keydown', function (event) {
            if ((event.key == 'p' || event.key == 'P') && (navigator.platform.match("Mac") ? event.metaKey : event.ctrlKey)) {// ctrl+p
                event.preventDefault();
                previewWindow.print()
            } else if ((event.key == 's' || event.key == 'S') && (navigator.platform.match("Mac") ? event.metaKey : event.ctrlKey)) {//ctrl+s
                event.preventDefault();
                localStorage.setItem("myVitae", editorArea.value)
            }
        })
        previewDoc.addEventListener('keydown', function (event) {
            if ((event.key == 'p' || event.key == 'P') && (navigator.platform.match("Mac") ? event.metaKey : event.ctrlKey)) {// ctrl+p
                event.preventDefault();
                previewWindow.print()
            }
            else if ((event.key == 's' || event.key == 'S') && (navigator.platform.match("Mac") ? event.metaKey : event.ctrlKey)) {//ctrl+s
                event.preventDefault();
                localStorage.setItem("myVitae", editorArea.value)
            }
        })
        document.addEventListener('keydown', function (event) {
            if ((event.key == 'p' || event.key == 'P') && (navigator.platform.match("Mac") ? event.metaKey : event.ctrlKey)) {// ctrl+p
                event.preventDefault();
                previewWindow.print()
            }
            else if ((event.key == 's' || event.key == 'S') && (navigator.platform.match("Mac") ? event.metaKey : event.ctrlKey)) {//ctrl+s
                event.preventDefault();
                localStorage.setItem("myVitae", editorArea.value)
            }
        })
        editorArea.addEventListener('mouseover', function (event) {
            scrollTarget = editorArea;
        })
        previewWindow.addEventListener('mouseover', function (event) {
            scrollTarget = previewWindow;
        })

        editorArea.addEventListener('scroll', function (event) {
            if (scrollLock && scrollTarget === editorArea) {
                previewWindow.scroll({
                    top: editorArea.scrollTop * (previewDoc.body.scrollHeight - previewDoc.body.clientHeight) / (editorArea.scrollHeight - editorArea.clientHeight),
                });
            }
        })
        previewWindow.addEventListener('scroll', function (event) {
            if (scrollLock && scrollTarget === previewWindow) {
                editorArea.scroll({
                    top: previewWindow.scrollY * (editorArea.scrollHeight - editorArea.clientHeight) / (previewDoc.body.scrollHeight - previewDoc.body.clientHeight),
                });
            }
        })

        editorArea.addEventListener('keyup', function () {
            str = editorArea.value;
            render(str)
        })

        scrollLockButton.addEventListener("click", function (event) {
            if (scrollLock) {
                showMessage(messageList, "解锁同步滚动")
                scrollLockButton.innerHTML = scrollUnlockHTML;
            }
            else {
                showMessage(messageList, "锁定同步滚动")
                scrollLockButton.innerHTML = scrollLockHTML;
            }
            scrollLock = !scrollLock;
        })

        createSaveIcon(saveButton);
        saveButton.addEventListener("click", function (event) {
            showMessage(messageList, "保存到localStorage")
            localStorage.setItem("myVitae", editorArea.innerText)
        })

        createPrintIcon(printButton);
        printButton.addEventListener("click", function (event) {
            previewWindow.print();
        })

        createClearIcon(clearButton);
        clearButton.addEventListener("click", async function (event) {
            showMessage(messageList, "清除localStorage")
            localStorage.removeItem("myVitae");
            render(await readAsStringAsync("./MyVitae.md"))
        })

        linkButton.addEventListener("click", function (event) {
            showLink += 1;
            showLink %= 3;
            switch (showLink) {
                case 0:
                    linkButton.innerHTML = showLinkHTML;
                    showMessage(messageList, "显示链接")
                    break;
                case 1:
                    linkButton.innerHTML = hideLinkHTML;
                    showMessage(messageList, "隐藏链接");
                    break;
                case 2:
                    linkButton.innerHTML = detailLinkHTML;
                    showMessage(messageList, "显示详细链接");
                    break;
            }
            render(str)
        })

        createStyleIcon(styleButton);
        styleButton.addEventListener("click", function (event) {
            styleIndex += 1;
            styleIndex %= styles.length;
            styleButton.getElementsByTagName('text')[0].innerHTML = styleIndex
            loadStyle(styles[styleIndex])
            showMessage(messageList, `风格切换到 ${styles[styleIndex]}`)
        })

        colorButton.addEventListener("click", function (event) {
            fullColor = !fullColor;
            if (fullColor) {
                colorButton.innerHTML = fullColorHTML;
                showMessage(messageList, "彩色显示");
                removeLinksFrom(previewDoc, `css/${styles[styleIndex]}/preview/gray.css`)
            } else {
                colorButton.innerHTML = grayColorHTML;
                showMessage(messageList, "灰度显示");
                loadLinksTo(previewDoc, `css/${styles[styleIndex]}/preview/gray.css`)
            }
        })

        function render(str, option) {
            if (!option) {
                option = {
                    showLink: showLink
                }
            }
            previewDoc.body.innerHTML = "";
            let subTokens = split(str)
            let titleModuleMap = {
                "个人信息": personalInformation,
                "教育经历": educationExperience,
                "获奖经历": award,
                "个人技能": personalSkill,
                "工作经历": workExperience,
                "项目经历": projectExperience,
            }
            let moduleOrder = [
                "个人信息",
                "教育经历",
                "获奖经历",
                "个人技能",
                "工作经历",
                "项目经历"
            ]
            for (let key of moduleOrder) {
                if (titleModuleMap[key] != null && subTokens[key] != null) {
                    previewDoc.body.appendChild(
                        titleModuleMap[key].render(
                            titleModuleMap[key].parse(
                                subTokens[key]
                            ),
                            option
                        )
                    )
                }
            }
            switch (option.showLink) {
                case 0:
                    break;
                case 1:
                    removeATag(previewDoc);
                    break;
                case 2:
                    expandATag(previewDoc);
                    break;
            }
            bindJumperByPosition(editorArea, previewDoc);
        }

    </script>

</body>

</html>